
```
one_thread_per_connection_thread_handler.cpp
sql_task_handler.cpp[handle_event()]
session_stage.cpp
sql_task_handler.cpp[handle_sql()]
	parse_stage.cpp
	resolve_stage.cpp
		stmt.cpp[create_stmt()]
			insert_stmt.cpp
	optimize_stage.cpp
		logical_plan_generator.cpp
		physical_plan_generator
	execute_stage
	
```


```
parse_stage:
	parse_defs: 增加数据结构，节点枚举和定义，命令类型SCF
	lex.l: 词法分析
	yacc_sql.y: 语法分析
	*common/type/attr_type.h/cpp: 对于新的数据类型
resolve_stage:
	stmt.h: 添加处理分支
	新建xxx_stmt.h/cpp
如果有算子
optimize_stage
无算子
command_executor: (include新建头文件)
新建xxx_executor.h/cpp: 
*storage/db
*storage/table
```

```
优化阶段：
1> optimize_stage.cpp: OptimizeStage::handle_request()
2> same: 调用create_logical_plan()，通过成员logical_plan_generator_生成逻辑计划
2> same: 调用generate_physical_plan()，同理

创建逻辑算子；
1> logical_plan_generator.cpp: 根据stmt类型选择create_plan()
2>

创建物理算子：
1> physical_plan_generator.cpp: 调用通用PhysicalPlanGenerator::create_plan()
2> same: 调用分发PhysicalPlanGenerator::create()
3> same: 根据逻辑算子参数类型选择对应的create_plan()
	递归调用create()创建并转换子算子;
	创建物理算子; 添加子算子;

调用算子：
1> sql_task_handler.cpp: 调用CliCommunicator::write_result()
2> cli_communicator.cpp: 调用PlainCommunicator::write_result()
3> plain_communicator.cpp: 调用PlainCommunicator::write_result_internal()
4> same: 调用SqlResult::open()
5> sql_result.cpp: 调用operator_->open()
	根据执行模式选择write_chunk_result()或者write_tuple_result()
5> same: 调用SqlResult::next_chunk()/next_tuple()
6> sql_result.cpp: 调用operator_->next()
```


## 一、项目整体架构概览

MiniOB 是一个教学型关系数据库，代码量适中（约2-3万行），非常适合学习数据库内核原理。

### 核心模块结构

miniob/src/observer/
├── net/              # 网络层：处理客户端连接
├── session/          # 会话层：SQL语句处理流程控制
├── sql/              # SQL层：解析、优化、执行
│   ├── parser/       # 词法语法分析
│   ├── stmt/         # SQL语句抽象
│   ├── optimizer/    # 查询优化器
│   └── executor/     # 执行器
└── storage/          # 存储层：数据持久化
    ├── record/       # 记录管理
    ├── index/        # 索引管理
    └── buffer/       # 缓冲区管理

## 二、学习路线（按理解难度递进）

### 【第1天】理解 SQL 执行流程

#### 1. 从服务器启动入口开始

// 程序入口，启动网络服务和初始化各个组件

**关键文件：**

- `main.cpp` - 程序入口
- `net/server.cpp` - 网络服务器（你当前看的文件）
- [session_stage.cpp](vscode-file://vscode-app/d:/VScode/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html) - **最重要！SQL处理主流程**

#### 2. 重点理解 SQL 处理的 5 个阶段

~~~
RC SessionStage::handle_sql(SQLStageEvent *sql_event)
{
  // 1. Query Cache - 查询缓存
  rc = query_cache_stage_.handle_request(sql_event);
  // 2. Parse - 词法语法分析
  rc = parse_stage_.handle_request(sql_event);
  // 3. Resolve - 语义分析，生成 Stmt
  rc = resolve_stage_.handle_request(sql_event);
  // 4. Optimize - 查询优化（生成物理计划）
  rc = optimize_stage_.handle_request(sql_event);
  // 5. Execute - 执行
  rc = execute_stage_.handle_request(sql_event);
}
~~~
**建议阅读顺序：**

~~~
session/session_stage.cpp (主流程) 
    ↓
sql/parser/parse_stage.cpp (如何解析SQL)
    ↓
sql/parser/resolve_stage.cpp (如何语义分析)
    ↓
sql/executor/execute_stage.cpp (如何执行)
~~~

### 【第2-3天】深入 SQL 解析器

#### 3. 理解词法和语法分析

```
# 重点文件
miniob/src/observer/sql/parser/
├── lex_sql.l          # Flex词法规则（定义token）
├── yacc_sql.y         # Bison语法规则（定义SQL语法）
├── parse_defs.h       # AST节点定义
└── parse_stage.cpp    # 解析入口
```

**学习要点：**

- `lex_sql.l`: 识别 SELECT、INSERT、WHERE 等关键字
- `yacc_sql.y`: 定义 SQL 语法规则（如 `select_stmt: SELECT select_list FROM table`）
- `parse_defs.h`: 查看 `SelectSqlNode`、`InsertSqlNode` 等结构

**实践任务：**

```
-- 追踪这条SQL的解析过程
SELECT * FROM t WHERE id = 1;
-- 在 yacc_sql.y 中找到对应的语法规则：
-- select_stmt -> select_attr -> from_clause -> where_clause
```
### 【第4-5天】理解 Stmt（语句抽象层）

#### 4. 从 SQL AST 到 Stmt

```
├── stmt.h              # 所有Stmt的基类
├── select_stmt.h       # SELECT语句
├── insert_stmt.h       # INSERT语句
└── filter_stmt.h       # WHERE条件处理
```

**核心概念：**

- **AST (抽象语法树)**: 解析器的直接输出（`ParsedSqlNode`）
- **Stmt**: 经过语义检查后的语句对象，包含表、字段等元数据

**学习示例：**

```
RC SelectStmt::create(Db *db, SelectSqlNode &select_sql, Stmt *&stmt)
{
  // 1. 检查表是否存在
  Table *table = db->find_table(select_sql.relations[0].c_str());
  // 2. 检查字段是否存在
  const FieldMeta *field = table->table_meta().field(attr_name);
  // 3. 创建 FilterStmt（WHERE条件）
  FilterStmt::create(...);
  // 4. 返回构造好的 SelectStmt
  stmt = new SelectStmt(table, fields, filter_stmt);
}
```

### 【第6-7天】深入执行器

#### 5. 理解 Operator（算子）模型

```
├── physical_operator.h           # 物理算子基类
├── table_scan_physical_operator.cpp  # 表扫描
├── predicate_physical_operator.cpp   # 谓词过滤
├── project_physical_operator.cpp     # 投影（选择列）
└── insert_physical_operator.cpp      # 插入
```

**执行器的核心思想：火山模型**

```
class PhysicalOperator {
  virtual RC open() = 0;   // 初始化
  virtual RC next() = 0;   // 获取下一条记录（迭代器模式）
  virtual RC close() = 0;  // 清理资源
};
// 典型的SELECT执行过程：
// TableScan -> Predicate(WHERE) -> Project(选择列) -> 返回结果
**追踪一个简单查询：**
SELECT id FROM t WHERE age > 18;
// 对应的算子树：
ProjectOperator (选择 id 列)
    ↓
PredicateOperator (过滤 age > 18)
    ↓
TableScanOperator (扫描表 t)
```

### 【第8-9天】理解存储层

#### 6. 记录和索引管理

```
├── record/
│   ├── record_manager.h    # 记录管理器
│   └── record_manager.cpp
├── index/
│   ├── bplus_tree.h        # B+树索引
│   └── index_scanner.h     # 索引扫描
├── buffer/
│   └── disk_buffer_pool.h  # 缓冲池（页面缓存）
└── table/
    └── table.h             # 表的完整接口
```

**学习重点：**

**1. 记录的存储格式**

```
// Record 由固定长度的字段组成
// 例如：CREATE TABLE t(id INT, name CHAR(10))
// 一条记录：[4字节id][10字节name]
```

**2. B+树索引结构**

```
// 学习：插入、删除、查找的实现
RC BplusTreeHandler::insert_entry(...);
RC BplusTreeHandler::delete_entry(...);
RC BplusTreeHandler::find(...);
```

### 【第10天】综合实践

#### 7. 实现一个完整功能（如 UPDATE）

**完整流程：**

1. yacc_sql.y - 添加语法规则
2. parse_defs.h - 定义 UpdateSqlNode
3. update_stmt.cpp - 创建 Stmt
4. update_executor.cpp - 实现执行逻辑
5. table.cpp - 添加 update_record 方法

## 三、推荐学习资料

### 官方资料

1. **OceanBase 数据库大赛官方文档**
    
    - [https://oceanbase.github.io/miniob/](vscode-file://vscode-app/d:/VScode/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)
    - 查看比赛题目和说明
2. **MiniOB GitHub Wiki**
    
    - [https://github.com/oceanbase/miniob/wiki](vscode-file://vscode-app/d:/VScode/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)
    - 阅读设计文档

### 数据库理论书籍

1. **《数据库系统概念》（Database System Concepts）**
    
    - 第12-15章：存储与索引
    - 第13章：查询处理
2. **《数据库系统实现》（Database System Implementation）**
    
    - 更偏向实现细节

### 在线资源

1. **CMU 15-445 数据库系统课程**
    
    - [https://15445.courses.cs.cmu.edu/](vscode-file://vscode-app/d:/VScode/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)
    - 配套 Lab 项目 BusTub
2. **Stanford CS346 数据库系统实现**
    
    - 理论与实现并重

## 四、调试技巧

### 1. 使用 GDB 调试

```
cd miniob/build
gdb ./bin/observer
# 设置断点
(gdb) b SessionStage::handle_sql
(gdb) b SelectStmt::create
(gdb) run
# 在另一个终端连接
./bin/obclient
> SELECT * FROM t;
```

### 2. 添加日志

```
// 在关键位置添加日志
LOG_INFO("Executing UPDATE: table=%s, field=%s", 
         table_name, field_name);
LOG_DEBUG("Updated %d records", count);
```

### 3. 使用 EXPLAIN 查看执行计划

EXPLAIN SELECT * FROM t WHERE id > 10;

-- 输出算子树结构

## 五、快速上手检查清单

### Day 1 - 搭建环境

- <input disabled="" type="checkbox"> 编译通过 MiniOB
- <input disabled="" type="checkbox"> 运行 observer 和 obclient
- <input disabled="" type="checkbox"> 执行基础 SQL：CREATE、INSERT、SELECT

### Day 2-3 - 理解流程

- <input disabled="" type="checkbox"> 阅读 [session_stage.cpp](vscode-file://vscode-app/d:/VScode/resources/app/out/vs/code/electron-sandbox/workbench/workbench.html)，理解 5 个阶段
- <input disabled="" type="checkbox"> 追踪一条 SELECT 语句的完整执行
- <input disabled="" type="checkbox"> 画出 SQL 处理流程图

### Day 4-5 - 深入模块

- <input disabled="" type="checkbox"> 理解 Stmt 的作用
- <input disabled="" type="checkbox"> 理解 Operator 的火山模型
- <input disabled="" type="checkbox"> 阅读 TableScan 和 Predicate 算子代码

### Day 6-7 - 存储层

- <input disabled="" type="checkbox"> 理解 Record 的存储格式
- <input disabled="" type="checkbox"> 理解 B+树索引的实现
- <input disabled="" type="checkbox"> 查看 Buffer Pool 的页面管理

### Day 8-10 - 实战

- <input disabled="" type="checkbox"> 实现 UPDATE 功能
- <input disabled="" type="checkbox"> 实现聚合函数（如 COUNT）
- <input disabled="" type="checkbox"> 优化查询性能（添加索引）

## 六、重点代码文件清单（按优先级）

### ⭐⭐⭐ 必读

session/session_stage.cpp       # SQL处理主流程

sql/executor/execute_stage.cpp  # 执行入口

sql/stmt/select_stmt.cpp        # SELECT语句

storage/table/table.cpp          # 表操作

### ⭐⭐ 重要

sql/parser/yacc_sql.y           # SQL语法

sql/parser/resolve_stage.cpp    # 语义分析

sql/operator/table_scan_physical_operator.cpp

storage/record/record_manager.cpp

### ⭐ 扩展

sql/optimizer/optimize_stage.cpp

storage/index/bplus_tree.cpp

storage/buffer/disk_buffer_pool.cpp

开始从 **`session/session_stage.cpp`** 这个文件入手，理解整个 SQL 的生命周期，然后逐步深入各个模块！

有任何具体问题随时问我，比如："SELECT 的执行流程具体是什么？" 或 "B+树索引是如何实现的？"